<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<!-- Модальное окно Настройки -->
<div aria-hidden="true" aria-labelledby="settingsModalLabel" class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">Настройки</h5>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
      </div>
      <div class="modal-body">
        <form id="settingsForm">
          <div class="mb-3">
            <label class="form-label" for="currencySelect">Выберите валюту</label>
            <select class="form-select" id="currencySelect">
              {% for currency in currencies %}
              <option %}
                      %}selected{% currency.code== endif if selected_currency value="{{ currency.code }}" {%>
                {{ currency.name }} ({{ currency.code }})
              </option>
              {% endfor %}
            </select>

          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Закрыть</button>
        <button class="btn btn-primary" onclick="saveSettings()" type="button">Сохранить</button>
      </div>
    </div>
  </div>
</div>


<script>
  function saveSettings() {
    const selectedCurrency = document.getElementById('currencySelect').value;

    fetch('/settings/save/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(), // Добавьте функцию получения CSRF-токена
      },
      body: JSON.stringify({ currency: selectedCurrency }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Настройки сохранены');
          const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
          settingsModal.hide();
        } else {
          alert('Ошибка сохранения настроек');
        }
      })
      .catch(err => console.error('Ошибка:', err));
  }
document.addEventListener('DOMContentLoaded', () => {
    fetch('/settings/get/')
        .then(response => response.json())
        .then(data => {
            if (data.currency) {
                document.getElementById('currencySelect').value = data.currency;
            }
        })
        .catch(err => console.error('Ошибка загрузки настроек:', err));
});



  // Открытие модального окна настроек
  document.querySelector('.bx-cog').addEventListener('click', () => {
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    settingsModal.show();
  });

  // Сохранение настроек
  function saveSettings() {
    const selectedCurrency = document.getElementById('currencySelect').value;

    // Сохраняем данные в локальное хранилище (или отправляем на сервер)
    localStorage.setItem('defaultCurrency', selectedCurrency);

    alert(`Валюта для категорий сохранена: ${selectedCurrency}`);

    // Закрываем модальное окно
    const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
    settingsModal.hide();
  }

  // Загрузка сохранённых настроек при загрузке страницы
  document.addEventListener('DOMContentLoaded', () => {
    const savedCurrency = localStorage.getItem('defaultCurrency');
    if (savedCurrency) {
      document.getElementById('currencySelect').value = savedCurrency;
    }
  });


  document.getElementById("logoutButton").onclick = function() {
      // Создаем скрытую форму для выхода
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/logout/';  // Путь выхода

      // Создаем скрытый input для CSRF-токена
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = getCSRFToken();
      form.appendChild(csrfInput);

      // Отправляем форму
      document.body.appendChild(form);
      form.submit();
  };


  function getCSRFToken() {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      return csrfToken;
  }


      let arrow = document.querySelectorAll(".arrow");
      for (var i = 0; i < arrow.length; i++) {
        arrow[i].addEventListener("click", (e)=>{
       let arrowParent = e.target.parentElement.parentElement;//selecting main parent of arrow
       arrowParent.classList.toggle("showMenu");
        });
      }
      let sidebar = document.querySelector(".sidebar");
      let sidebarBtn = document.querySelector(".bx-menu");
      console.log(sidebarBtn);
      sidebarBtn.addEventListener("click", ()=>{
        sidebar.classList.toggle("close");
      });
</script>
</body>
</html>